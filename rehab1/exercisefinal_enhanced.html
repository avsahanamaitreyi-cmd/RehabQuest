<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <link rel="icon" href="logo.png" type="image/png" />
  <title>Exercise Session</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <style>
    button:hover {
      cursor: pointer;
    }
    #input_video {
      display: none;
    }

    .video-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
    }
    video, canvas {
      width: 640px;
      height: 480px;
      border-radius: var(--card-radius);
      border: 1px solid var(--border);
    }
    .exercise-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin: 20px 0;
    }
    .exercise-btn {
      padding: 12px 18px;
      border-radius: 12px;
      background: var(--card);
      border: 1px solid var(--border);
      color: var(--text);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .exercise-btn:hover {
      background: var(--accent);
      color: var(--bg);
    }
    .exercise-btn.active {
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      color: var(--bg);
    }
    .audio-controls {
      margin: 10px 0;
    }
    .debug-info {
      background: var(--card);
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 12px;
      color: var(--text-2);
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav">
    <div class="container">
      <div class="logo">
        <div class="dot"></div>
        RehabQuest
      </div>
      <div class="header-actions">
        <span>Exercise Tracker</span>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container">
    <!-- Hero Section -->
    <div class="hero">
      <h1>Exercise Session Tracker</h1>
      <p>Real-time pose detection and movement analysis for rehabilitation exercises</p>
    </div>

    <!-- Patient Configuration -->
    <div class="card">
      <h2 class="section-title">Patient Configuration</h2>
      <div style="margin: 16px 0;">
        <label for="patientId" style="display: block; margin-bottom: 8px; color: var(--text-2);">Patient ID:</label>
        <input type="text" id="patientId" placeholder="Enter patient ID" style="padding: 8px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); width: 200px;"/>
      </div>

      <!-- Audio Controls -->
      <div class="audio-controls">
        <label>
          <input type="checkbox" id="audioFeedback" checked style="margin-right: 6px;"/>
          Enable Audio Feedback
        </label>
      </div>

      <!-- Debug Info -->
      <div id="debugInfo" class="debug-info">
        Debug: Waiting for exercise...
      </div>
    </div>

    <!-- Session Controls -->
    <div class="card">
      <h2 class="section-title">Session Controls</h2>
      <div class="row">
        <button id="startBtn" class="btn">Start Camera</button>
        <button id="stopBtn" class="btn secondary" disabled>Stop Camera</button>
        <button id="endSessionBtn" class="btn secondary" disabled>End Session & Save</button>
      </div>
    </div>

    <!-- Exercise Selection -->
    <div class="card">
      <h2 class="section-title">Select Exercise</h2>
      <div class="exercise-grid">
        <button class="exercise-btn" data-exercise="squat" data-ex="squat">üèãÔ∏è Squats</button>
        <button class="exercise-btn" data-exercise="jumping_jacks" data-ex="jumping_jacks">ü§∏ Jumping Jacks</button>
        <button class="exercise-btn" data-exercise="bicep_curls" data-ex="bicep_curls">üí™ Bicep Curls</button>
        <button class="exercise-btn" data-exercise="pushups" data-ex="pushups">ü§≤ Pushups</button>
        <button class="exercise-btn" data-exercise="shoulder_abduction" data-ex="shoulder_abduction">üôÜ Shoulder Abduction</button>
      </div>
      <div style="margin-top: 16px; color: var(--text-2);">
        <strong>Selected Exercise:</strong> <span id="selectedExercise">None</span>
      </div>
    </div>

    <!-- Live Feed & Analysis -->
    <div class="card">
      <h2 class="section-title">Live Feed & Analysis</h2>
      <div class="video-container">
        <div>
          <h4 style="text-align: center; margin-bottom: 10px;">Your Performance</h4>
          <video id="input_video" playsinline autoplay muted></video>
          <canvas id="output_canvas"></canvas>
        </div>
        <div>
          <h4 style="text-align: center; margin-bottom: 10px;">Reference Video</h4>
          <video id="record_video" autoplay muted playsinline controls loop style="width: 640px; height: 480px;"></video>
        </div>
      </div>
    </div>

    <!-- Performance Metrics -->
    <div class="card">
      <h2 class="section-title">Performance Metrics</h2>
      <div class="grid cols-3">
        <div class="kpi">
          <div class="value" id="repCount">0</div>
          <div style="color: var(--text-2); font-size: 14px;">Repetitions</div>
        </div>
        <div class="kpi">
          <div class="value" id="pointsCount">0</div>
          <div style="color: var(--text-2); font-size: 14px;">Points Earned</div>
        </div>
        <div class="kpi">
          <div class="value" id="rejectedReps">0</div>
          <div style="color: var(--text-2); font-size: 14px;">Rejected Reps</div>
        </div>
      </div>

      <!-- Quality Assessment Section -->
      <div class="card" style="margin-top: 20px;">
        <h3 class="section-title">Quality Assessment</h3>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="kpi">
            <div>
              <div class="value" id="form">-</div>
              <div style="color: var(--text-2); font-size: 14px;">Form Accuracy (%)</div>
            </div>
          </div>
          <div class="kpi">
            <div>
              <div class="value" id="adherence">-</div>
              <div style="color: var(--text-2); font-size: 14px;">Adherence (%)</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Feedback Section -->
    <div class="card">
      <h3 class="section-title">Real-time Feedback</h3>
      <div id="feedbackText" style="padding: 16px; background: var(--bg); border-radius: 8px; border: 1px solid var(--border); margin: 16px 0;">
        Ready to start exercising...
      </div>
    </div>
  </div>

 


  <!-- Audio Elements -->
  <audio id="repCompleteSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvWYfCjiGq4nDeSwF" type="audio/wav">
  </audio>
  <audio id="goodFormSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvWYfCjiGq4nDeSwF" type="audio/wav">
  </audio>
  <audio id="encouragementSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvWYfCjiGq4nDeSwF" type="audio/wav">
  </audio>

  <script>
    // DOM Elements
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const endSessionBtn = document.getElementById('endSessionBtn');
    const videoEl = document.getElementById('input_video');
    const canvasEl = document.getElementById('output_canvas');
    const ctx = canvasEl.getContext('2d');
    const repEl = document.getElementById('repCount');
    const pointsEl = document.getElementById('pointsCount');
    const rejectedRepsEl = document.getElementById('rejectedReps');
    const formEl = document.getElementById('form');
    const adherenceEl = document.getElementById('adherence');
    const selectedExerciseEl = document.getElementById('selectedExercise');
    const feedbackEl = document.getElementById('feedbackText');
    const debugEl = document.getElementById('debugInfo');
    const recordVideoEl = document.getElementById('record_video');

    // Audio elements
    const repSound = document.getElementById('repCompleteSound');
    const goodFormSound = document.getElementById('goodFormSound');
    const encouragementSound = document.getElementById('encouragementSound');

    // Speech synthesis
    const speechSynth = window.speechSynthesis;

    // Exercise state variables
    let camera;
    let running = false;
    let reps = 0; // Only counts accurate reps
    let rejectedReps = 0; // Counts rejected reps due to poor form
    let points = 0;
    let totalFrames = 0;
    let goodFormFrames = 0;
    let currentExercise = null;
    let exerciseState = "start";
    let lastRepTime = 0;
    let encouragementCounter = 0;
    let sessionStartTime = 0;

    // Form tracking variables for corrective feedback
    let poorFormCounter = 0;
    let lastCorrectiveFeedback = 0;
    let currentFormScore = 100;
    let formWarningGiven = false;
    let framesSinceLastCheck = 0;

    // Minimum form score to count a rep as valid
    const MIN_FORM_SCORE_FOR_REP = 60; // Only reps with 60%+ form quality count

    function speakFeedback(message) {
      if (document.getElementById('audioFeedback').checked && speechSynth) {
        // Stop any current speech immediately
        speechSynth.cancel();

        // Create new message
        const utterance = new SpeechSynthesisUtterance(message);
        utterance.rate = 1.2;
        utterance.pitch = 1.1;

        // Speak new one
        speechSynth.speak(utterance);

        // Debug log
        console.log("Speaking:", message);
      }
    }

    function playSound(audioElement) {
      if (document.getElementById('audioFeedback').checked) {
        audioElement.currentTime = 0;
        audioElement.play().catch(e => console.log('Audio play failed:', e));
      }
    }

    function updateFeedback(message, isPositive = true) {
      feedbackEl.innerHTML = `<span style="color: ${isPositive ? 'var(--success)' : 'var(--danger)'};}">${message}</span>`;
    }

    function updateDebugInfo(angle, exercise, state, formScore) {
      debugEl.innerHTML = `Debug: ${exercise} | State: ${state} | Angle: ${angle.toFixed(1)}¬∞ | Form Score: ${formScore} | Poor Form Counter: ${poorFormCounter}`;
    }

    // Form evaluation and corrective feedback
    function checkFormAndProvideFeedback(angle, exercise, exerciseState) {
      const currentTime = Date.now();
      let formScore = 100;
      let needsCorrection = false;

      // Exercise-specific form evaluation with more aggressive thresholds
      if (exercise === "squat" && exerciseState === "down") {
        if (angle > 120) { // Not squatting deep enough
          formScore = 20;
          needsCorrection = true;
        } else if (angle > 100) {
          formScore = 50;
        } else if (angle < 70) {
          formScore = 95;
        } else {
          formScore = 80;
        }
      } else if (exercise === "bicep_curls" && exerciseState === "curl") {
        if (angle > 100) { // Not curling high enough
          formScore = 25;
          needsCorrection = true;
        } else if (angle > 70) {
          formScore = 55;
        } else if (angle < 40) {
          formScore = 95;
        } else {
          formScore = 80;
        }
      } else if (exercise === "pushups" && exerciseState === "down") {
        if (angle > 175) { // Not going down enough
          formScore = 20;
          needsCorrection = true;
        } else if (angle > 170) {
          formScore = 50;
        } else if (angle < 160) {
          formScore = 95;
        } else {
          formScore = 75;
        }
      } else if (exercise === "jumping_jacks" && exerciseState === "up") {
        if (angle < 140) { // Arms not high enough
          formScore = 30;
          needsCorrection = true;
        } else if (angle < 160) {
          formScore = 60;
        } else {
          formScore = 90;
        }
      } else if (exercise === "shoulder_abduction" && exerciseState === "up") {
        if (angle < 100) { // Arms not raised enough
          formScore = 25;
          needsCorrection = true;
        } else if (angle < 120) {
          formScore = 60;
        } else {
          formScore = 90;
        }
      }

      currentFormScore = formScore;

      // Give corrective feedback when form is bad
      if (needsCorrection && (currentTime - lastCorrectiveFeedback) > 2000) {
        lastCorrectiveFeedback = currentTime;

        const correctiveFeedbacks = {
          "squat": [
            "Squat deeper! Go down until your thighs are parallel to the ground!",
            "You're not squatting low enough. Bend your knees more!",
            "Lower! Your squat needs to be deeper!",
            "Sit back and squat down further!"
          ],
          "bicep_curls": [
            "Curl higher! Bring your hand up to your shoulder!",
            "You need to curl all the way up. Lift higher!",
            "Incomplete curl! Bring your hand closer to your shoulder!",
            "Curl your arm higher for a complete movement!"
          ],
          "pushups": [
            "Go lower! Your chest should nearly touch the ground!",
            "You're not going down far enough in your pushup!",
            "Lower your body more! That's not a full pushup!",
            "Push down deeper until your chest almost touches the floor!"
          ],
          "jumping_jacks": [
            "Raise your arms higher! They should go above your head!",
            "Your arms aren't high enough! Reach up more!",
            "Lift your arms all the way up for proper jumping jacks!",
            "Arms higher! Reach above your head!"
          ],
          "shoulder_abduction": [
            "Raise your arms higher! Lift them to shoulder level!",
            "Your arm lift is too low. Raise them up more!",
            "Lift your arms higher for proper shoulder abduction!",
            "Arms need to go higher! Lift to shoulder height!"
          ]
        };

        const feedbacks = correctiveFeedbacks[exercise] || [
          "Adjust your position and try again!",
          "Focus on proper form and full range of motion!",
          "Your movement range is too small. Go further!"
        ];

        const randomFeedback = feedbacks[Math.floor(Math.random() * feedbacks.length)];
        speakFeedback(randomFeedback);
        updateFeedback(randomFeedback, false);

        console.log("CORRECTIVE FEEDBACK GIVEN:", randomFeedback);
      }

      return formScore;
    }

    // Reference video functionality
    let exercise_name = "";
    const buttons = document.querySelectorAll(".exercise-btn");

    buttons.forEach(button => {
      button.addEventListener("click", () => {
        exercise_name = button.getAttribute("data-ex");
        console.log("Selected exercise:", exercise_name);

        // Update reference video source based on selected exercise
        if (exercise_name === "squat") {
          recordVideoEl.src = "squats.mp4";
        } else if (exercise_name === "jumping_jacks") {
          recordVideoEl.src = "jumping_jacks.mp4";
        } else if (exercise_name === "bicep_curls") {
          recordVideoEl.src = "bicep_curls.mp4";
        } else if (exercise_name === "pushups") {
          recordVideoEl.src = "pushups.mp4";
        } else if (exercise_name === "shoulder_abduction") {
          recordVideoEl.src = "shoulder_abduction.mp4";
        }
        recordVideoEl.load();
        recordVideoEl.play().catch(e => console.log('Reference video play failed:', e));
      });
    });

    // Pose setup
    const pose = new Pose({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${file}`
    });
    pose.setOptions({
      modelComplexity: 1,
      smoothLandmarks: true,
      minDetectionConfidence: 0.1,
      minTrackingConfidence: 0.1
    });
    pose.onResults(onResults);

    // Camera controls
    startBtn.addEventListener('click', async () => {
      try {
        running = true;
        sessionStartTime = Date.now();
        camera = new Camera(videoEl, {
          onFrame: async () => {
            if (running) {
              await pose.send({ image: videoEl });
            }
          },
          width: 640,
          height: 480
        });
        await camera.start();

        startBtn.disabled = true;
        stopBtn.disabled = false;
        endSessionBtn.disabled = false;
        updateFeedback("Camera started! Select an exercise to begin.");
        speakFeedback("Camera is ready. Please select an exercise to start your workout.");
      } catch (error) {
        updateFeedback("Camera access failed. Please allow camera permissions.", false);
      }
    });

    stopBtn.addEventListener('click', () => {
      running = false;
      if (camera) {
        camera.stop();
      }
      startBtn.disabled = false;
      stopBtn.disabled = true;
      updateFeedback("Camera stopped.");
    });

    // Exercise selection
    document.querySelectorAll('.exercise-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.exercise-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentExercise = btn.dataset.exercise;
        exerciseState = "start";

        // Reset tracking variables
        poorFormCounter = 0;
        lastCorrectiveFeedback = 0;
        currentFormScore = 100;
        formWarningGiven = false;

        selectedExerciseEl.textContent = btn.textContent;
        updateFeedback(`${btn.textContent} selected. Begin when ready!`);
        speakFeedback(`${btn.textContent} exercise selected. You can start when ready.`);
      });
    });

    function onResults(results) {
      canvasEl.width = results.image.width;
      canvasEl.height = results.image.height;
      ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
      ctx.drawImage(results.image, 0, 0, canvasEl.width, canvasEl.height);

      if (results.poseLandmarks) {
        drawConnectors(ctx, results.poseLandmarks, Pose.POSE_CONNECTIONS, {color: '#22d3ee'});
        drawLandmarks(ctx, results.poseLandmarks, {color: '#a78bfa', radius: 3});
        totalFrames++;

        if (currentExercise && running) {
          detectExercise(results.poseLandmarks, currentExercise);
        }
      } else if (currentExercise && running) {
        updateFeedback("Please ensure you're fully visible in the camera frame.", false);
      }
    }

    function calculateAngle(a, b, c) {
      const ab = Math.sqrt(Math.pow(b.x - a.x, 2) + Math.pow(b.y - a.y, 2));
      const bc = Math.sqrt(Math.pow(b.x - c.x, 2) + Math.pow(b.y - c.y, 2));
      const ac = Math.sqrt(Math.pow(c.x - a.x, 2) + Math.pow(c.y - a.y, 2));
      return Math.acos((bc * bc + ab * ab - ac * ac) / (2 * bc * ab)) * (180 / Math.PI);
    }

    function detectExercise(landmarks, exercise) {
      const LHip = landmarks[23], LKnee = landmarks[25], LAnkle = landmarks[27];
      const RHip = landmarks[24], RKnee = landmarks[26], RAnkle = landmarks[28];
      const LShoulder = landmarks[11], LElbow = landmarks[13], LWrist = landmarks[15];
      const RShoulder = landmarks[12], RElbow = landmarks[14], RWrist = landmarks[16];

      let angle = 180;
      let formQuality = "good";
      let repDetected = false;

      if (exercise === "squat") {
        const leftKneeAngle = calculateAngle(LHip, LKnee, LAnkle);
        const rightKneeAngle = calculateAngle(RHip, RKnee, RAnkle);
        angle = (leftKneeAngle + rightKneeAngle) / 2;

        if (exerciseState === "start" && angle < 90) {
          exerciseState = "down";
          updateFeedback("Good squat position! Now stand back up.");
        } else if (exerciseState === "down" && angle > 160) {
          repDetected = true;
          exerciseState = "start";
          formQuality = angle > 170 ? "excellent" : "good";
        }

        // Check form continuously during the down phase
        if (exerciseState === "down") {
          currentFormScore = checkFormAndProvideFeedback(angle, exercise, exerciseState);
        }
      }

      if (exercise === "jumping_jacks") {
        const leftArmAngle = calculateAngle(LShoulder, LElbow, LWrist);
        const rightArmAngle = calculateAngle(RShoulder, RElbow, RWrist);
        angle = (leftArmAngle + rightArmAngle) / 2;

        if (exerciseState === "start" && angle > 160) {
          exerciseState = "up";
          updateFeedback("Arms up! Now bring them down.");
        } else if (exerciseState === "up" && angle < 60) {
          repDetected = true;
          exerciseState = "start";
          formQuality = "good";
        }

        // Check form during up phase
        if (exerciseState === "up") {
          currentFormScore = checkFormAndProvideFeedback(angle, exercise, exerciseState);
        }
      }

      if (exercise === "bicep_curls") {
        const leftArmAngle = calculateAngle(LShoulder, LElbow, LWrist);
        angle = leftArmAngle;

        if (exerciseState === "start" && angle < 60) {
          exerciseState = "curl";
          updateFeedback("Nice curl! Now lower your arm slowly.");
        } else if (exerciseState === "curl" && angle > 150) {
          repDetected = true;
          exerciseState = "start";
          formQuality = "good";
        }

        // Check form during curl phase
        if (exerciseState === "curl") {
          currentFormScore = checkFormAndProvideFeedback(angle, exercise, exerciseState);
        }
      }

      if (exercise === "pushups") {
        const bodyAngle = calculateAngle(LShoulder, LHip, LKnee);
        angle = bodyAngle;

        if (exerciseState === "start" && angle < 160) {
          exerciseState = "down";
          updateFeedback("Lower position reached! Push back up.");
        } else if (exerciseState === "down" && angle > 170) {
          repDetected = true;
          exerciseState = "start";
          formQuality = angle > 175 ? "excellent" : "good";
        }

        // Check form during down phase
        if (exerciseState === "down") {
          currentFormScore = checkFormAndProvideFeedback(angle, exercise, exerciseState);
        }
      }

      if (exercise === "shoulder_abduction") {
        const leftArmAngle = calculateAngle(LShoulder, LElbow, LWrist);
        angle = leftArmAngle;

        if (exerciseState === "start" && angle > 120) {
          exerciseState = "up";
          updateFeedback("Arms raised! Now lower them down.");
        } else if (exerciseState === "up" && angle < 40) {
          repDetected = true;
          exerciseState = "start";
          formQuality = "good";
        }

        // Check form during up phase
        if (exerciseState === "up") {
          currentFormScore = checkFormAndProvideFeedback(angle, exercise, exerciseState);
        }
      }

      // Update debug info
      updateDebugInfo(angle, exercise, exerciseState, currentFormScore);

      // Handle rep completion with QUALITY FILTERING
      if (repDetected) {
        const currentTime = Date.now();

        // ONLY COUNT REPS WITH GOOD FORM
        if (currentFormScore >= MIN_FORM_SCORE_FOR_REP) {
          reps++; // Only increment if form is good enough

          // Points based on form score
          let pointsEarned = 5;
          if (currentFormScore >= 90) {
            pointsEarned = 15;
            formQuality = "excellent";
          } else if (currentFormScore >= 70) {
            pointsEarned = 10;
            formQuality = "good";
          } else {
            pointsEarned = 7;
            formQuality = "fair";
          }

          points += pointsEarned;
          goodFormFrames += Math.max(5, currentFormScore / 10);
          lastRepTime = currentTime;

          playSound(repSound);

          // Positive verbal feedback for accepted reps
          let verbalFeedback;
          if (formQuality === "excellent") {
            const excellentFeedbacks = [
              `Perfect form! ${reps} excellent repetitions completed!`,
              `Outstanding technique! ${reps} reps with perfect form!`
            ];
            verbalFeedback = excellentFeedbacks[Math.floor(Math.random() * excellentFeedbacks.length)];
          } else if (formQuality === "good") {
            const goodFeedbacks = [
              `Good job! ${reps} repetitions completed with solid form!`,
              `Well done! ${reps} reps with good technique!`
            ];
            verbalFeedback = goodFeedbacks[Math.floor(Math.random() * goodFeedbacks.length)];
          } else {
            const fairFeedbacks = [
              `Rep accepted! ${reps} completed. Try for better form next time.`,
              `${reps} reps done. Good effort!`
            ];
            verbalFeedback = fairFeedbacks[Math.floor(Math.random() * fairFeedbacks.length)];
          }

          speakFeedback(verbalFeedback);
          updateFeedback(`Rep ${reps} completed with ${formQuality} form! (+${pointsEarned} points)`);

          // Milestone encouragements
          if (reps % 5 === 0 && reps > 0) {
            setTimeout(() => {
              speakFeedback(`Great milestone! ${reps} repetitions completed!`);
              playSound(encouragementSound);
            }, 1000);
          }
        } else {
          // REP REJECTED DUE TO POOR FORM
          rejectedReps++;

          const rejectionFeedbacks = [
            "Rep not counted due to poor form. Focus on proper technique!",
            "Form too poor - rep rejected. Improve your technique and try again!",
            "That rep doesn't count. Focus on full range of motion!",
            "Rejected rep. Slow down and focus on correct form!"
          ];

          const rejectionFeedback = rejectionFeedbacks[Math.floor(Math.random() * rejectionFeedbacks.length)];
          speakFeedback(rejectionFeedback);
          updateFeedback(rejectionFeedback, false);

          console.log("REP REJECTED - Form score:", currentFormScore);
        }

        // Reset form tracking for next rep
        currentFormScore = 100;
      }

      // Update display
      repEl.innerText = reps;
      rejectedRepsEl.innerText = rejectedReps;
      pointsEl.innerText = points;

      // Update form and adherence percentages
      if (totalFrames > 0) {
        const formPct = (goodFormFrames / totalFrames) * 100;
        const adherencePct = Math.min(formPct * 1.2, 100);
        formEl.innerText = formPct.toFixed(1);
        adherenceEl.innerText = adherencePct.toFixed(1);
      }
    }

    // End session functionality
    endSessionBtn.addEventListener('click', async () => {
      const patientId = document.getElementById('patientId').value.trim();

      if (!patientId) {
        updateFeedback("Please enter a Patient ID before saving.", false);
        speakFeedback("Please enter your patient I.D. before saving the session.");
        return;
      }

      if (reps === 0) {
        updateFeedback("No valid repetitions recorded. Please complete some exercises with proper form before saving.", false);
        speakFeedback("No valid exercises completed. Please do some repetitions with good form before saving.");
        return;
      }

      try {
        // Calculate final metrics
        const formAccuracy = totalFrames > 0 ? (goodFormFrames / totalFrames) * 100 : 0;
        const adherence = Math.min(formAccuracy * 1.2, 100);

        // Save session data
        await saveSession(
          patientId,
          currentExercise || "mixed",
          reps,
          formAccuracy,
          adherence,
          points
        );

        const totalAttempts = reps + rejectedReps;
        const successRate = totalAttempts > 0 ? (reps / totalAttempts * 100).toFixed(1) : 0;

        updateFeedback(`Session saved! ${reps} valid reps, ${rejectedReps} rejected reps. Success rate: ${successRate}%.`);
        speakFeedback(`Great work! Your session has been saved. You completed ${reps} valid repetitions out of ${totalAttempts} attempts. Success rate ${successRate} percent. Redirecting to your session summary.`);

        // Redirect to the JSP summary page with patientId
        window.location.href = `exercise_summary.jsp?patientId=${patientId}`;

      } catch (error) {
        console.error('Save error:', error);
        updateFeedback("Error saving session. Please check your connection and try again.", false);
        speakFeedback("There was an error saving your session. Please try again.");
      }
    });

    async function saveSession(patientId,exercise_name, totalReps, correctForm, adherence, pointsEarned) {
      alert("inside save session"+"Exercisename"+exercise_name+"pointsEarned"+pointsEarned);
      const response = await fetch("http://127.0.0.1:5000/save_session", {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "Access-Control-Allow-Origin": "*"
        },
        body: JSON.stringify({
          patient_id: patientId,
          exercise_name: exercise_name,
          total_reps: totalReps,
          correct_form: correctForm.toFixed(2),
          adherence: adherence.toFixed(2),
          points_Earned: pointsEarned
        })
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();
      console.log("Session saved:", result);
      return result;
    }

    // Initialize
    updateFeedback("Welcome to RehabQuest! Click 'Start Camera' to begin your exercise session.");

    // Periodic encouragement for long sessions (only for good performance)
    setInterval(() => {
      if (running && currentExercise && reps > 0) {
        const sessionDuration = (Date.now() - sessionStartTime) / 1000 / 60; // minutes
        const currentFormPct = totalFrames > 0 ? (goodFormFrames / totalFrames) * 100 : 0;

        if (sessionDuration > 2 && sessionDuration % 2 === 0 && currentFormPct > 60) {
          speakFeedback("Keep up the great work! You're doing fantastic!");
          playSound(encouragementSound);
        }
      }
    }, 60000);
  </script>
</body>
</html>